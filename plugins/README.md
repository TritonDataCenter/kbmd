# kbmd plugin interface

## Introduction

kbmd uses a plugin to manage the PINs for the PIV tokens it uses, as well as
to manage the recovery configurations and recovery tokens used in the eboxes
used to store zpool keys. By utilizing a plugin, different backends can be used
depending on the needs of the operator. Initially only a plugin for Triton
is being delivered. The plugin allows kbmd to interact with the KBMAPI service.

The eventual goal is to allow other distributions to be able to supply their
own plugins to match their own schemes for managing PINs, etc. As such, most
of these interfaces were designed with KBMAPI in mind, though are versioned
which should hopefully allow for relatively painless evolving of the interfaces
as required.

## Overview

The plugin itself is a standalone binary (or script) that implements the
methods documented below. The plugin is invoked by kbmd using the pattern
`plugin <method> <args>`. A plugin should exit with an exit value of 0 on
success, and non-zero on error. Errors should be written to stderr, and any
data to be returned to kbmd (as described by the corresponding method) should
be written to stdout.

When kbmd starts, it will search its plugin directory (see kbmd(1M) for
details on how the plugin directory is determined) and attempt to call the
`version` method on each plugin until it finds a plugin that returns a
supported version (or it exhausts the list of files in the plugin directory).
That plugin is then used for all subsequent operations.

## Methods

### version

Usage: `$plugin version`

Return the version of the plugin. No arguments are given. The output should
be a sequence of `key=value` pairs, one pair per line (order is not important).
Currently, the following two keys should be returned:
 # name - A descriptive name for the plugin
 # version - The version of the plugin API the plugin implements.  The version
should be a stringified integer value (e.g. '1', '1234', etc.). The current
version is 1.

Example:

```
$ plugin version
name=My Plugin
version=1
$
```
 
### get-pin

Usage: `$plugin get-pin GUID`

Return the PIN for the PIV token identified by `GUID`.  The PIN should be
written on a single line to stdout (or exit with a non-zero exit value on error).

Example:

```
$ plugin get-pin 7DD7E2DE9855E4E33188AFC3CC00EA17
123456
```

### register-pivtoken

Usage: `$plugin register-pivtoken`

Called to register a PIV token that's been initialized by kbmd. kbmd will write a JSON
description of the PIV token to stdin with at least the following properties:
 - guid: The GUID of the newly initialized PIV token.
 - cn_uuid: The UUID of the system containing the PIV token.
 - pin: The randomly generated PIN (created by kbmd during PIV token
initialization) for the PIV token.
 - model: The model of the PIV token (optional, may not be present).
 - serial: The serial number of the PIV token (optional, may not be present).
 - pubkeys: A hash of the public keys that were created on the PIV token during
initialization. These will include at least the '9a', '9d', and '9e' keys.
 - attestation: An attestation certificate to prove the generated keys were
actually created by the PIV token (and not uploaded).  Optional.

(In an incredible coincidence, this happens to be the exact format expected
by the POST /pivtokens KBMAPI method).

The plugin should output two lines on stdout. The first line is a recovery
token that is used to prove to the backend a recovery has taken place. This
is a 32-byte base64 encoded value. It should be randomly generated by the
backend. The second line is a base64 encoded recovery config, compatible with
a template created by pivy-box.

Example:
```
$ plugin register-pivtoken
jmzbhT2PXczgber9jyOSApRP337gkshM7EqK5gOhAcg=
6wwBAQECAQEBCG5pc3RwMjU2IQNCMyUrRPQmdi17OjSGVkdcXbXz3oJMsTpFEr3TPmDApgQQV1aRdpDz9smIDN2cQ/16QAIDamJrAwAAAGgAAAATZWNkc2Etc2hhMi1uaXN0cDI1NgAAAAhuaXN0cDI1NgAAAEEEXV+YctfCrWrDVMr00GISG8KeUOQ9LIjrDKcLuBEMyOxBzkOPdA7CzEBhfFMLq6YIWMmk/UJt8Zzr5Hxe4/2oQwA=
```

### replace-pivtoken

Usage: `$plugin replace-pivtoken OLDGUID RECOVERY\_TOKEN`

Called when a PIV token has been replaced during a recovery process. `OLDGUID`
is the GUID of the old/previous PIV token and `RECOVERY\_TOKEN` is the
recovery token value (from PIV token registration). It otherwise works the
same as the `register-pivtoken` method -- the newly initialized replacement
PIV token is passed to stdin, and the plugin should output the new
recovery token (and current recovery config) on stdout.

### new-rtoken

Usage: `$plugin new-rtoken GUID`

Called when replacing an existing PIV token with a new one outside of a
recovery process. `GUID` is the GUID if the PIV token being replaced, and
the new PIV token details are written to stdin of the plugin process, similar
to the `replace-pivtoken` method.

The plugin should then return a recovery token and recovery configuration
similar to the `replace-pivtoken` method.

### post-rcfg-update

Usage: $plugin post-rcfg-update

Called after a recovery configuration has been updated. The triton plugin
uses this to force a sysinfo refresh (e.g. run `sysinfo -u`).
