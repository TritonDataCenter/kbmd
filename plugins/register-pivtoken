#!/bin/bash

#
# Copyright 2019, Joyent, Inc.
#

# register-pivtoken: Register a newly initialize PIV token
#
# Args:
#   none
#
# Input:
#   JSON blob containing token data, structured as required by KBMAPI
#
# Output:
#   The recovery token generated by the server (aka KBMAPI)
#
# On success 0 is returned, otherwise a non-zero error is returned.
# value is logged by kbmd for troubleshooting purposes.  Currently any
# stderr output is discarded (until a better way of dealing with it in kbmd
# is devised).

PIVYTOOL=/usr/sbin/pivy-tool
CURL=/usr/bin/curl
OPENSSL=/usr/bin/openssl

VERSION="1"

while getopts "v" opt; do
    case "$opt" in
        v)
            echo "$VERSION"
            exit 0
            ;;
    esac
done
shift $((OPTIND - 1))

# XXX: This needs more work
host=$(json -f /system/boot/networking.json datacenter_name dns_domain | \
    sed 'N;s/\n/./')
path=pivtokens
url="http://kbmapi.$host/$path"

date="$(date +"%a, %d %b %Y %T %Z")"
sig="$(echo $date | $PIVYTOOL sign 9e | $OPENSSL enc -base64 -A)"

rtoken=$(cat - | $CURL -sS \
    -H "Date: $date" \
    -H "Authorization: $sig" \
    "$url") || exit 1

echo $rtoken
